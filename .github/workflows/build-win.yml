name: Build Galaga MSI

on: [push, pull_request]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Clean build folders
        shell: pwsh
        run: |
          Remove-Item -Recurse -Force classes, dist -ErrorAction SilentlyContinue
          Remove-Item Galaga.jar, sources.txt -ErrorAction SilentlyContinue

      - name: Compile Java sources
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force classes
          $files = Get-ChildItem -Recurse -Filter *.java src | ForEach-Object { $_.FullName }
          javac -d classes $files

      - name: Create JAR
        shell: pwsh
        run: |
          jar --create `
              --file Galaga.jar `
              --main-class galaga.Galaga `
              -C classes .

      - name: Clean other folders
        shell: pwsh
        run: |
          Get-ChildItem -Recurse | Where-Object {
              $_.FullName -notmatch 'Galaga\.jar$' -and
              $_.FullName -notmatch 'classes$' -and
              $_.FullName -notmatch '\\.github\\preview\\galaga\.ico$'
          } | Remove-Item -Recurse -Force

      - name: Build MSI with jpackage
        shell: pwsh
        run: |
          jpackage `
            --type msi `
            --name Galaga `
            --icon ./.github/preview/galaga.ico `
            --app-version 1.0 `
            --description "Classic Galaga arcade game clone" `
            --copyright "Â© 2025 Galaga - @jules1univ" `
            --input . `
            --main-jar Galaga.jar `
            --main-class galaga.Galaga `
            --install-dir Galaga `
            --win-dir-chooser `
            --win-menu `
            --win-menu-group "Games" `
            --win-shortcut `
            --win-per-user-install `
            --java-options "-Xmx512m" `
            --dest dist `
            --verbose

      - name: Upload Galaga Installer
        uses: actions/upload-artifact@v4
        with:
          name: Galaga-Windows-MSI
          path: dist/*.msi
